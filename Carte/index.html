<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
         <style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
}

#map {
    width: 100%;
    height: 100%;
}
</style>
        <title>Carte Interactive</title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/proj4.js"></script>
        <script src="js/proj4leaflet.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/OccupationduSol_0.js"></script>
        <script src="data/Hydrographie_1.js"></script>
        <script src="data/Route_2.js"></script>
        <script src="data/Localit_3.js"></script>
        <script>
var obj2 = {};
var obj3 = {};
			
var map = L.map('map', {
            continuousWorld: false,
            worldCopyJump: false, 
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[-2.8124791344803683,15.528803778748062],[-2.488709695580104,16.093081559267052]]);

        // --- AJOUT DES FONDS DE CARTE ---
        var layer_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            minZoom: 1,
            maxZoom: 28,
            zIndex: 0
        }).addTo(map);

        var layer_Satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            minZoom: 1,
            maxZoom: 28,
            zIndex: 0
        });
        // --------------------------------

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() { popup.update(); });
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                }
            }
        }

        var zoomControl = L.control.zoom({ position: 'topleft' }).addTo(map);
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
        document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

        var bounds_group = new L.featureGroup([]);
        function setBounds() {}

        function pop_OccupationduSol_0(feature, layer) {
            var popupContent = '<table>\
                    <tr><th scope="row">Type</th><td>' + (feature.properties['Type'] !== null ? autolinker.link(String(feature.properties['Type'])) : '') + '</td></tr>\
                    <tr><td colspan="2">Ha : ' + (feature.properties['ha'] !== null ? feature.properties['ha'] : '') + '</td></tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_OccupationduSol_0_0(feature) {
            switch(String(feature.properties['Type'])) {
                case 'Forêt dense': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(97,133,83,1.0)', fill: true, fillColor: 'rgba(97,133,83,1.0)', interactive: true };
                case 'Forêt claire': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(156,194,59,1.0)', fill: true, fillColor: 'rgba(156,194,59,1.0)', interactive: true };
                case 'Savane arborée dense': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(177,102,33,1.0)', fill: true, fillColor: 'rgba(177,102,33,1.0)', interactive: true };
                case 'Savane arborée de moyenne densité': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(208,116,30,1.0)', fill: true, fillColor: 'rgba(208,116,30,1.0)', interactive: true };
                case 'Savane arborée de faible densité': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(239,127,22,1.0)', fill: true, fillColor: 'rgba(239,127,22,1.0)', interactive: true };
                case 'Savane herbeuse ou arbustive, dense': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(255,154,59,1.0)', fill: true, fillColor: 'rgba(255,154,59,1.0)', interactive: true };
                case 'Savane herbeuse ou arbustive': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(249,198,150,1.0)', fill: true, fillColor: 'rgba(249,198,150,1.0)', interactive: true };
                case 'Mosaïque Savane herbeuse ou arbustive et champs': return { pane: 'pane_OccupationduSol_0', opacity: 1, color: 'rgba(233,173,222,1.0)', fill: true, fillColor: 'rgba(233,173,222,1.0)', interactive: true };
            }
        }

        map.createPane('pane_OccupationduSol_0');
        map.getPane('pane_OccupationduSol_0').style.zIndex = 400;
        var layer_OccupationduSol_0 = new L.geoJson(json_OccupationduSol_0, {
            interactive: true,
            pane: 'pane_OccupationduSol_0',
            onEachFeature: pop_OccupationduSol_0,
            style: style_OccupationduSol_0_0,
        });
        bounds_group.addLayer(layer_OccupationduSol_0);
        map.addLayer(layer_OccupationduSol_0);

        function pop_Hydrographie_1(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['NOM'] !== null ? feature.properties['NOM'] : 'Cours d\'eau') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Hydrographie_1_0(feature) {
            return { pane: 'pane_Hydrographie_1', opacity: 1, color: 'rgba(10,89,248,1.0)', weight: (feature.properties['Type'] === 'Principal' ? 2.0 : 1.0), interactive: true };
        }
        map.createPane('pane_Hydrographie_1');
        map.getPane('pane_Hydrographie_1').style.zIndex = 401;
        var layer_Hydrographie_1 = new L.geoJson(json_Hydrographie_1, {
            interactive: true,
            pane: 'pane_Hydrographie_1',
            onEachFeature: pop_Hydrographie_1,
            style: style_Hydrographie_1_0,
        });
        bounds_group.addLayer(layer_Hydrographie_1);
        map.addLayer(layer_Hydrographie_1);

        function pop_Route_2(feature, layer) {
            var popupContent = '<table><tr><td colspan="2">' + (feature.properties['DESCRIPTIO'] !== null ? feature.properties['DESCRIPTIO'] : 'Route') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Route_2_0(feature) {
            var style = { pane: 'pane_Route_2', opacity: 1, color: 'rgba(247,14,6,1.0)', weight: 1.0, interactive: true };
            if (feature.properties['DESCRIPTIO'] === 'Route publique principale') style.weight = 2.0;
            if (feature.properties['DESCRIPTIO'] === 'Piste') style.dashArray = '4.0,2.0';
            return style;
        }
        map.createPane('pane_Route_2');
        map.getPane('pane_Route_2').style.zIndex = 402;
        var layer_Route_2 = new L.geoJson(json_Route_2, {
            interactive: true,
            pane: 'pane_Route_2',
            onEachFeature: pop_Route_2,
            style: style_Route_2_0,
        });
        bounds_group.addLayer(layer_Route_2);
        map.addLayer(layer_Route_2);

        function pop_Localit_3(feature, layer) {
            var popupContent = '<table><tr><th scope="row">Toponyme</th><td>' + (feature.properties['Toponyme'] !== null ? feature.properties['Toponyme'] : '') + '</td></tr></table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Localit_3_0(feature) {
            return { pane: 'pane_Localit_3', radius: (feature.properties['Type'] === 'Chef-lieu de district' ? 4.0 : 2.0), opacity: 1, color: 'rgba(35,35,35,1.0)', fill: true, fillColor: 'rgba(4,4,4,1.0)', interactive: true };
        }
        map.createPane('pane_Localit_3');
        map.getPane('pane_Localit_3').style.zIndex = 403;
        var layer_Localit_3 = new L.geoJson(json_Localit_3, {
            interactive: true,
            pane: 'pane_Localit_3',
            onEachFeature: pop_Localit_3,
            pointToLayer: function (feature, latlng) { return L.circleMarker(latlng, style_Localit_3_0(feature)); },
        });
        bounds_group.addLayer(layer_Localit_3);
        map.addLayer(layer_Localit_3);

        // Configuration Photon Search
        var photonControl = L.control.photon({
            url: "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
            position: 'topleft',
            includePosition: true,
        }).addTo(map);

        // --- GESTION DU MENU DES COUCHES ---
        var baseMaps = {
            "Plan (OpenStreetMap)": layer_OSM,
            "Satellite (Esri)": layer_Satellite
        };
			
        var overlaysTree = [
            {label: 'Localité', layer: layer_Localit_3},
            {label: 'Route', layer: layer_Route_2},
            {label: 'Hydrographie', layer: layer_Hydrographie_1},
            {label: 'Occupation du Sol', layer: layer_OccupationduSol_0},
        ];

        var lay = L.control.layers.tree(baseMaps, overlaysTree, { collapsed: false });
        lay.addTo(map);

        // Finalisation labels et recherche
        layer_Localit_3.eachLayer(function(layer) {
            layer.bindTooltip((layer.feature.properties['Toponyme'] !== null?String('<div style="color: #323232; font-size: 9pt; font-weight: bold; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['Toponyme']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Localit_3'});
        });

        map.addControl(new L.Control.Search({
            layer: layer_OccupationduSol_0,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Type'}));

        setBounds();
        </script>
    </body>
</html>
