<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                margin: 0;
            }
        </style>
        <title>Carte d'Occupation du Sol</title>
    </head>
    <body>
        <div id="map"></div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/proj4.js"></script>
        <script src="js/proj4leaflet.js"></script>
        <script src="js/leaflet-search.js"></script>
        
        <script src="data/OccupationduSol_0.js"></script>
        <script src="data/Hydrographie_1.js"></script>
        <script src="data/Route_2.js"></script>
        <script src="data/Localit_3.js"></script>

        <script>
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        }).fitBounds([[-2.8124791344803683,15.528803778748062],[-2.488709695580104,16.093081559267052]]);

        var hash = new L.Hash(map);
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        // --- FONDS DE CARTE ---
        var layer_OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            zIndex: 0
        }).addTo(map);

        var layer_Satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri',
            zIndex: 0
        });

        // --- FONCTIONS POPUPS ET MEDIA (Originales) ---
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                }
            }
        }

        // --- STYLES DES COUCHES ---
        function style_OccupationduSol_0_0(feature) {
            var colors = {
                'Forêt dense': 'rgba(97,133,83,1.0)',
                'Forêt claire': 'rgba(156,194,59,1.0)',
                'Savane arborée dense': 'rgba(177,102,33,1.0)',
                'Savane arborée de moyenne densité': 'rgba(208,116,30,1.0)',
                'Savane arborée de faible densité': 'rgba(239,127,22,1.0)',
                'Savane herbeuse ou arbustive, dense': 'rgba(255,154,59,1.0)',
                'Savane herbeuse ou arbustive': 'rgba(249,198,150,1.0)',
                'Mosaïque Savane herbeuse ou arbustive et champs': 'rgba(233,173,222,1.0)'
            };
            return {
                pane: 'pane_OccupationduSol_0',
                opacity: 1, color: colors[feature.properties['Type']],
                fill: true, fillColor: colors[feature.properties['Type']],
                interactive: true, weight: 1
            };
        }

        // --- CHARGEMENT DES COUCHES ---
        map.createPane('pane_OccupationduSol_0');
        map.getPane('pane_OccupationduSol_0').style.zIndex = 400;
        var layer_OccupationduSol_0 = new L.geoJson(json_OccupationduSol_0, {
            pane: 'pane_OccupationduSol_0',
            style: style_OccupationduSol_0_0,
            onEachFeature: function(feature, layer) {
                var popupContent = '<table><tr><th scope="row">Type</th><td>' + (feature.properties['Type'] !== null ? autolinker.link(String(feature.properties['Type'])) : '') + '</td></tr></table>';
                layer.bindPopup(popupContent, {maxHeight: 400});
            }
        }).addTo(map);

        // --- GESTION DES COUCHES ET LEGENDE ---
        var baseMaps = {
            "Plan (OpenStreetMap)": layer_OSM,
            "Satellite (Esri)": layer_Satellite
        };

        var overlaysTree = [
            {label: 'Occupation du Sol<br /><table><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Forêtdense0.png" /></td><td>Forêt dense</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Forêtclaire1.png" /></td><td>Forêt claire</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Savanearboréedense2.png" /></td><td>Savane arborée dense</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Savanearboréedemoyennedensité3.png" /></td><td>Savane arborée de moyenne densité</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Savanearboréedefaibledensité4.png" /></td><td>Savane arborée de faible densité</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Savaneherbeuseouarbustivedense5.png" /></td><td>Savane herbeuse ou arbustive, dense</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_Savaneherbeuseouarbustive6.png" /></td><td>Savane herbeuse ou arbustive</td></tr><tr><td style="text-align: center;"><img src="legend/OccupationduSol_0_MosaïqueSavaneherbeuseouarbustiveetchamps7.png" /></td><td>Mosaïque Savane herbeuse ou arbustive et champs</td></tr></table>', layer: layer_OccupationduSol_0}
        ];

        var lay = L.control.layers.tree(baseMaps, overlaysTree, {collapsed: false});
        lay.addTo(map);

        // AJOUT DES CONTROLES
        L.control.zoom({position: 'topleft'}).addTo(map);
        new L.Control.Measure({position: 'topleft'}).addTo(map);

        </script>
    </body>
</html>
